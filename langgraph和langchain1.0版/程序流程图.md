# 智能导游系统程序流程图

## 系统整体架构

```mermaid
graph TB
    A[用户输入] --> B[用户认证检查]
    B --> C{是否已登录?}
    C -->|否| D[显示登录页面]
    C -->|是| E[Chat函数处理]

    E --> F[获取会话历史]
    F --> G[初始化LangGraph状态]
    G --> H[React推理循环]
    H --> I[工具选择与执行]
    I --> J[生成最终回复]
    J --> K[更新会话历史]
    K --> L[返回结果给用户]

    M[文件系统] --> N[知识库初始化]
    O[数据库] --> P[SQL查询执行]
    Q[天气API] --> R[天气信息获取]

    N --> I
    P --> I
    R --> I
```

## 核心React推理流程

```mermaid
graph TD
    A[开始推理] --> B[用户问题分析]
    B --> C{问题类型判断}

    C -->|景点详细介绍| D[选择chroma_search]
    C -->|景点列表/概览| E[选择sql_search]
    C -->|天气询问| F[选择weather_search]
    C -->|其他| G[尝试混合工具]

    D --> H[执行知识库检索]
    E --> I[执行SQL查询]
    F --> J[执行天气查询]
    G --> H

    H --> K[重排序结果]
    I --> L[格式化查询结果]
    J --> M[解析天气数据]

    K --> N[合并结果到状态]
    L --> N
    M --> N

    N --> O{达到最大调用次数?}
    O -->|否| P{能完整回答?}
    O -->|是| Q[生成最终答案]

    P -->|否| R[继续推理循环]
    P -->|是| Q

    R --> C
    Q --> S[结束]
```

## 知识库检索流程

```mermaid
graph LR
    A[文档加载] --> B{文件类型判断}

    B -->|PDF| C[PyPDFLoader]
    B -->|TXT/MD| D[TextLoader + 编码检测]
    B -->|DOC/DOCX| E[Docx2txtLoader]
    B -->|其他| F[UnstructuredPDFLoader]

    C --> G[文档切分]
    D --> G
    E --> G
    F --> G

    G --> H[文本块分割<br/>1000字符重叠100]
    H --> I{向量库是否存在?}

    I -->|否| J[创建新向量库]
    I -->|是| K[加载现有向量库]

    J --> L[添加文档到Chroma]
    K --> M[追加文档到现有库]

    L --> N[混合检索]
    M --> N

    N --> O[向量检索 + BM25检索]
    O --> P[DashScope重排序]
    P --> Q[返回Top 4结果]
```

## LangGraph状态流转

```mermaid
stateDiagram-v2
    [*] --> react_reasoning
    react_reasoning --> should_continue

    state should_continue {
        [*] --> check_final_answer
        check_final_answer --> 有最终答案: end
        check_final_answer --> 无最终答案: check_max_calls
        check_max_calls --> 达到最大次数: generate_final
        check_max_calls --> 未达到最大次数: continue_reasoning
    }

    should_continue --> end: [*]
    should_continue --> continue_reasoning: react_reasoning
    should_continue --> generate_final: response_generation

    response_generation --> [*]
```

## 数据库交互流程

```mermaid
graph TB
    A[SQL查询请求] --> B[表名检查]
    B --> C{是否包含错误表名?}

    C -->|scenic_spots| D[替换为attractions]
    C -->|正确表名| E[直接执行查询]
    D --> E

    E --> F[执行SQL语句]
    F --> G{查询成功?}

    G -->|是| H[格式化结果]
    G -->|否| I[返回错误信息]

    H --> J[添加到数据源列表]
    I --> K[记录错误日志]

    J --> L[返回结果]
    K --> L
```

## 天气查询流程

```mermaid
sequenceDiagram
    participant User as 用户
    participant LLM as 大模型
    participant WeatherTool as 天气工具
    participant WeatherAPI as 天气API

    User->>LLM: 询问天气
    LLM->>LLM: 识别天气相关请求
    LLM->>WeatherTool: 调用weather_search
    WeatherTool->>WeatherAPI: 发起HTTP请求
    WeatherAPI-->>WeatherTool: 返回JSON数据
    WeatherTool-->>LLM: 格式化天气信息
    LLM-->>User: 返回天气结果
```

## 系统初始化流程

```mermaid
graph TD
    A[程序启动] --> B[加载环境变量]
    B --> C[初始化通义千问模型]
    C --> D[配置日志系统]
    D --> E[建立数据库连接]
    E --> F[初始化向量嵌入模型]
    F --> G[扫描知识库文件]
    G --> H{知识库文件存在?}

    H -->|是| I[加载并处理文档]
    H -->|否| J[创建空知识库]

    I --> K[构建向量数据库]
    J --> K
    K --> L[初始化LangGraph工作流]
    L --> M[系统就绪]

    M --> N[等待用户请求]
```

## 错误处理机制

```mermaid
graph TB
    A[工具执行] --> B{执行成功?}

    B -->|成功| C[正常返回结果]
    B -->|失败| D[捕获异常]

    D --> E{错误类型}

    E -->|SQL错误| F[记录SQL错误日志]
    E -->|网络错误| G[记录网络错误]
    E -->|文件错误| H[记录文件处理错误]
    E -->|其他错误| I[记录通用错误]

    F --> J[尝试重试或降级处理]
    G --> J
    H --> J
    I --> J

    J --> K{是否可继续?}
    K -->|是| L[继续执行]
    K -->|否| M[返回错误给用户]

    L --> C
```

## 主要组件交互图

```mermaid
graph TB
    subgraph "用户界面层"
        A[Web前端]
        B[登录页面]
    end

    subgraph "业务逻辑层"
        C[Chat函数]
        D[LangGraph工作流]
        E[React推理引擎]
    end

    subgraph "工具层"
        F[知识库检索]
        G[SQL查询工具]
        H[天气查询工具]
    end

    subgraph "数据层"
        I[Chroma向量库]
        J[MySQL数据库]
        K[文档文件]
        L[天气API]
    end

    A --> C
    B --> C
    C --> D
    D --> E
    E --> F
    E --> G
    E --> H
    F --> I
    F --> K
    G --> J
    H --> L
```

## 关键数据结构

```mermaid
classDiagram
    class ChatState {
        +messages: List[BaseMessage]
        +current_query: str
        +rewritten_query: str
        +tool_results: Dict[str, Any]
        +sources: List[Dict[str, str]]
        +final_response: str
        +agent_scratchpad: List[BaseMessage]
        +tool_calls_made: int
        +max_tool_calls: int
    }

    class ToolsDefinition {
        +chroma_search: ToolInfo
        +sql_search: ToolInfo
        +weather_search: ToolInfo
    }

    class ToolInfo {
        +name: str
        +description: str
        +parameters: Dict
    }

    ChatState --> ToolsDefinition
```

## 程序执行时序

```mermaid
sequenceDiagram
    participant User as 用户
    participant Chat as Chat函数
    participant LangGraph as LangGraph
    participant React as React推理节点
    participant Tools as 工具执行
    participant DB as 数据库/API

    User->>Chat: 发送消息
    Chat->>LangGraph: 创建初始状态
    LangGraph->>React: 开始推理

    loop React循环
        React->>React: 分析问题
        React->>Tools: 选择工具
        Tools->>DB: 执行查询
        DB-->>Tools: 返回结果
        Tools-->>React: 工具结果
        React->>React: 评估结果
    end

    React->>LangGraph: 生成最终答案
    LangGraph-->>Chat: 返回结果
    Chat-->>User: 显示回复
```

这个流程图涵盖了整个智能导游系统的主要流程，包括用户交互、React推理机制、知识库检索、数据库查询、天气查询等核心功能模块。